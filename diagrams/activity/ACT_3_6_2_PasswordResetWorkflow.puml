@startuml Password Reset Workflow Activity

title Figure 3.X: Password Reset Workflow Activity Diagram

skinparam backgroundColor #FEFEFE
skinparam ActivityBackgroundColor #E3F2FD
skinparam ActivityBorderColor #1976D2
skinparam ActivityDiamondBackgroundColor #FFF9C4
skinparam ActivityDiamondBorderColor #F57F17
skinparam ArrowColor #333333

|#E3F2FD|User|
|#E8F5E9|System|
|#FCE4EC|Email Service|

|User|
start
:Click "Forgot Password" Link;
:Enter Email Address;

|System|
:Validate Email Format;

if (Valid Format?) then (yes)
    :Search User by Email;
    
    if (User Found?) then (yes)
        :Generate Secure Token
        (secrets.token_urlsafe(32));
        :Set Token Expiry
        (current_time + 1 hour);
        :Store Token in Database;
        :Build Reset URL;
        
        |Email Service|
        :Send Password Reset Email
        with Reset Link;
        
        |User|
        :Display "Check your email";
        :Open Email;
        :Click Reset Link;
        
        |System|
        :Extract Token from URL;
        :Validate Token Exists;
        
        if (Token Exists?) then (yes)
            :Check Token Expiry;
            
            if (Token Expired?) then (yes)
                :Delete Expired Token;
                
                |User|
                :Display "Link has expired.
                Please request a new one.";
                stop
            else (no)
                |User|
                :Display New Password Form;
                :Enter New Password;
                :Confirm New Password;
                
                |System|
                :Validate Passwords Match;
                
                if (Passwords Match?) then (yes)
                    :Validate Password Strength
                    (min 8 chars, uppercase, number);
                    
                    if (Strong Enough?) then (yes)
                        :Hash New Password
                        (make_password());
                        :Update User Password;
                        :Delete All User Tokens
                        (invalidate previous);
                        
                        |Email Service|
                        :Send Confirmation Email
                        "Password Changed Successfully";
                        
                        |User|
                        :Display "Password changed!
                        Redirecting to login...";
                        :Wait 3 Seconds;
                        :Redirect to Login Page;
                        :Enter New Credentials;
                        
                        |System|
                        :Validate Credentials;
                        :Generate JWT Tokens;
                        
                        |User|
                        :Access Dashboard;
                        stop
                    else (no)
                        |User|
                        :Display "Password must be
                        at least 8 characters
                        with uppercase and number";
                        note right: Return to form
                    endif
                else (no)
                    |User|
                    :Display "Passwords do not match";
                    note right: Return to form
                endif
            endif
        else (no)
            |User|
            :Display "Invalid or expired link.
            Please request a new one.";
            stop
        endif
    else (no)
        |User|
        :Display "Check your email"
        (same message for security);
        note right: Don't reveal if email exists
        stop
    endif
else (no)
    |User|
    :Display "Invalid email format";
    note right: Return to form
endif

@enduml
