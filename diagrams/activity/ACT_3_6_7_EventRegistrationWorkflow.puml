@startuml Event Registration Workflow Activity

title Figure 3.X: Event Registration Workflow Activity Diagram

skinparam backgroundColor #FEFEFE
skinparam ActivityBackgroundColor #E3F2FD
skinparam ActivityBorderColor #1976D2
skinparam ActivityDiamondBackgroundColor #FFF9C4
skinparam ActivityDiamondBorderColor #F57F17
skinparam ArrowColor #333333

|#LightBlue|Tourist|
|#E8F5E9|System|
|#FFE0B2|Admin|
|#FCE4EC|Email Service|

|Tourist|
start
:Navigate to Events Page;

|System|
:Fetch Upcoming Events
(is_published=True, future dates);
:Calculate Capacity Status
for Each Event;
:Display Event Cards
with Availability Indicators;

|Tourist|
:Browse Events;
:Select Event;

|System|
:Fetch Event Details
- Description
- Date/Time
- Location
- Capacity
- Custom Form Fields;
:Display Event Details
with Registration Status;

|Tourist|
:Click "Register for Event";

|System|
:Check Event Capacity;

if (Event Full?) then (yes)
    |Tourist|
    :Display "Event is full";
    
    if (Join Waitlist?) then (yes)
        :Enter Name and Email;
        
        |System|
        :Add to Waitlist;
        
        |Tourist|
        :Display "Added to waitlist.
        We'll notify if spots open.";
    else (no)
        :Browse Other Events;
    endif
    stop
else (no)
    |Tourist|
    :Display Registration Form
    - Standard Fields
    - Custom Fields (from config);
    
    :Fill Registration Form
    - Full Name
    - Email
    - Phone
    - Custom Responses;
    
    |System|
    :Validate Form Data;
    
    if (Valid Data?) then (yes)
        :Re-check Capacity
        (prevent race condition);
        
        if (Still Available?) then (yes)
            :Check for Duplicate
            (same email for event);
            
            if (Already Registered?) then (yes)
                |Tourist|
                :Display "You're already
                registered for this event!";
                stop
            else (no)
                |System|
                :Check Event Settings;
                
                if (Requires Approval?) then (yes)
                    :Create Registration
                    (status='pending');
                    
                    |Email Service|
                    fork
                        :Send Pending Notice to Tourist
                        "Registration received,
                        awaiting approval";
                    fork again
                        :Notify Admin
                        "New registration pending";
                    end fork
                    
                    |Tourist|
                    :Display "Registration submitted!
                    Pending approval.";
                    
                    ' === ADMIN APPROVAL FLOW ===
                    |Admin|
                    :Receive Notification;
                    :Login to Admin Portal;
                    :View Pending Registrations;
                    :Review Registration Details
                    and Custom Form Data;
                    
                    if (Approve?) then (yes)
                        |System|
                        :Update Status = 'confirmed';
                        
                        |Email Service|
                        :Send Approval Email
                        "Registration Approved! ✓";
                        
                        |Tourist|
                        :Receive Confirmation;
                        
                    else (no)
                        |Admin|
                        :Enter Rejection Reason;
                        
                        |System|
                        :Update Status = 'rejected';
                        
                        |Email Service|
                        :Send Rejection Email
                        with Reason;
                        
                        |Tourist|
                        :Receive Rejection;
                    endif
                    
                else (no - Auto Confirm)
                    |System|
                    :Create Registration
                    (status='confirmed');
                    :Generate Confirmation Code;
                    
                    |Email Service|
                    :Send Confirmation Email
                    "You're registered! ✓
                    Confirmation: EVT-2026-XXXX";
                    
                    |Tourist|
                    :Display "You're registered!
                    Confirmation sent to email.";
                endif
            endif
        else (no)
            |Tourist|
            :Display "Sorry, event just
            filled up!";
            stop
        endif
    else (no)
        |Tourist|
        :Display Validation Errors;
        note right: Return to form
    endif
endif

' === CANCEL REGISTRATION ===
|Tourist|
:View My Registrations;
:Select Registration to Cancel;
:Confirm Cancellation;

|System|
:Delete Registration;

|Email Service|
:Send Cancellation Confirmation;

|Tourist|
:Registration Cancelled;

stop

@enduml
