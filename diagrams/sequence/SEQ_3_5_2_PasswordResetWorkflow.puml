@startuml Password Reset Workflow Sequence

title Figure 3.9: Password Reset Workflow Sequence

skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2
skinparam roundcorner 10

actor "User" as U #LightBlue
participant "Frontend\n(React)" as FE #E3F2FD
participant "Backend\n(Django REST)" as BE #E8F5E9
database "Database\n(PostgreSQL)" as DB #FFF3E0
participant "Email Service\n(SMTP)" as EMAIL #FCE4EC

== Step 1: Request Password Reset ==

U -> FE: Click "Forgot Password" link
FE --> U: Display password reset form

U -> FE: Enter email address
FE -> FE: Validate email format

FE -> BE: POST /api/auth/password-reset/\n{email: "user@example.com"}

BE -> DB: SELECT * FROM users\nWHERE email = {email}
DB --> BE: User record (or null)

alt User Not Found
    BE --> FE: 200 OK\n{message: "If email exists, reset link sent"}
    note right of BE: Return success even if\nemail not found (security)
    FE --> U: "Check your email for reset link"
    
else User Found
    BE -> BE: Generate secure token\n(secrets.token_urlsafe(32))
    BE -> BE: Set token expiry\n(current_time + 1 hour)
    
    BE -> DB: INSERT INTO password_reset_tokens\n(user_id, token, expires_at)
    DB --> BE: Token stored
    
    BE -> BE: Build reset URL:\nfrontend_url/reset-password?token={token}
    
    BE -> EMAIL: Send reset email\n{to: user.email, reset_link: url}
    EMAIL --> U: "Password Reset Request\nClick link to reset"
    
    BE --> FE: 200 OK\n{message: "Reset link sent"}
    FE --> U: "Check your email for reset link"
end

== Step 2: Verify Reset Token ==

U -> EMAIL: Open email
U -> U: Click reset link

U -> FE: Navigate to /reset-password?token={token}
FE -> FE: Extract token from URL

FE -> BE: POST /api/auth/password-reset/verify/\n{token: "{token}"}

BE -> DB: SELECT * FROM password_reset_tokens\nWHERE token = {token}
DB --> BE: Token record

alt Token Not Found
    BE --> FE: 400 Bad Request\n{error: "Invalid token"}
    FE --> U: "Invalid or expired link.\nPlease request a new one."
    
else Token Expired
    BE -> BE: Check: expires_at < now()
    BE -> DB: DELETE FROM password_reset_tokens\nWHERE token = {token}
    DB --> BE: Token deleted
    BE --> FE: 400 Bad Request\n{error: "Token expired"}
    FE --> U: "Link has expired.\nPlease request a new one."
    
else Token Valid
    BE --> FE: 200 OK\n{valid: true, email: "user@example.com"}
    FE --> U: Display new password form\n(show masked email)
end

== Step 3: Set New Password ==

U -> FE: Enter new password\n+ Confirm password
FE -> FE: Validate password strength\n(min 8 chars, uppercase, number)

alt Passwords Don't Match
    FE --> U: "Passwords do not match"
else Password Too Weak
    FE --> U: "Password must be at least\n8 characters with uppercase and number"
else Valid Password
    FE -> BE: POST /api/auth/password-reset/confirm/\n{token: "{token}", new_password: "****"}
    
    BE -> DB: SELECT * FROM password_reset_tokens\nWHERE token = {token}
    DB --> BE: Token record with user_id
    
    BE -> BE: Validate token not expired
    
    BE -> BE: Hash new password\n(make_password())
    
    BE -> DB: UPDATE users\nSET password = {hashed_password}\nWHERE id = {user_id}
    DB --> BE: Password updated
    
    BE -> DB: DELETE FROM password_reset_tokens\nWHERE user_id = {user_id}
    DB --> BE: All user tokens invalidated
    
    BE -> EMAIL: Send confirmation email
    EMAIL --> U: "Password Changed Successfully\nIf this wasn't you, contact support"
    
    BE --> FE: 200 OK\n{message: "Password reset successful"}
    FE --> U: "Password changed!\nRedirecting to login..."
    
    FE -> FE: Redirect to login page\nafter 3 seconds
end

== Step 4: Login with New Password ==

U -> FE: Enter credentials with new password
FE -> BE: POST /api/auth/login/\n{username, password}
BE -> DB: Validate credentials
DB --> BE: User authenticated
BE --> FE: 200 OK {access_token, refresh_token}
FE --> U: Redirect to Dashboard

@enduml
