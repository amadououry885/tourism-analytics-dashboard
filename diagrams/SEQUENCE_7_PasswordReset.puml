@startuml Password Reset Sequence

title Password Reset Flow

skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2

actor User as U #LightBlue
participant "Frontend\n(React)" as FE #E3F2FD
participant "Backend\n(Django)" as BE #E8F5E9
database "Database" as DB #FFF3E0
participant "Email\nService" as ES #FFEBEE

U -> FE: Click "Forgot Password"
FE --> U: Show email form

U -> FE: Enter email
FE -> BE: POST /api/auth/password-reset/\n{email}

BE -> DB: Find user by email
DB --> BE: User (or null)

alt User not found
    BE --> FE: 200 OK
    note right: Security: same response\nwhether found or not
else User found
    BE -> BE: Generate secure token
    BE -> DB: CREATE PasswordResetToken\n{user_id, token, expiry: 1hr}
    DB --> BE: Token saved
    
    BE -> ES: Send reset email\nwith link containing token
    ES --> U: Email: "Reset your password\nClick here: /reset?token=xxx"
    
    BE --> FE: 200 OK
end

FE --> U: "If email exists,\nyou'll receive a link"

== User Clicks Reset Link ==

U -> FE: Click email link\n/reset?token=xxx
FE -> BE: POST /api/auth/password-reset/validate/\n{token}

BE -> DB: Find token
DB --> BE: Token record

alt Token invalid/expired
    BE --> FE: 400 "Invalid or expired"
    FE --> U: "Link expired.\nRequest new one."
else Token valid
    BE --> FE: 200 OK
    FE --> U: Show new password form
    
    U -> FE: Enter new password (x2)
    FE -> FE: Validate match
    
    FE -> BE: POST /api/auth/password-reset/confirm/\n{token, new_password}
    
    BE -> DB: UPDATE User password
    DB --> BE: Updated
    
    BE -> DB: Mark token as used
    DB --> BE: Token invalidated
    
    BE -> ES: Send confirmation
    ES --> U: Email: "Password changed"
    
    BE --> FE: 200 OK
    FE --> U: "Password reset!\nPlease login."
end

@enduml
